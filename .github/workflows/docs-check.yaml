name: Docs Check

on:
  pull_request:
    # types: [ready_for_review]
    types: [opened, synchronize, reopened, edited]

jobs:
  docs-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 1Ô∏è‚É£ Get PR body
      - name: Get PR body
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.pull_request.body || "";
            fs.writeFileSync('pr_body.txt', body, 'utf8');
            core.setOutput("body", body);

      # 2Ô∏è‚É£ Check if "No Docs Needed" is checked
      - name: Check for No Docs Needed checkbox
        id: skip
        run: |
          if grep -Eiq '\[x\].*no docs needed' pr_body.txt; then
            echo "üü° 'No Docs Needed' checked ‚Äî skipping docs enforcement."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # 3Ô∏è‚É£ Get changed files
      - name: Get changed files
        run: |
          git fetch origin main
          git diff --name-only origin/main...HEAD > changed_files.txt
          cat changed_files.txt

      # 4Ô∏è‚É£ Enforce docs update unless skipped
      - name: Enforce docs update
        run: |
          if [ "${{ steps.skip.outputs.skip }}" = "true" ]; then
            echo "üü° Skipping docs check (No Docs Needed checked)."
            exit 0
          fi

          if grep -q '^docs/' changed_files.txt; then
            echo "‚úÖ Docs updated."
          else
            echo "‚ùå No docs changes found and 'No Docs Needed' not checked."
            exit 1
          fi